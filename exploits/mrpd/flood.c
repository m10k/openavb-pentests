#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include "common.h"

static void usage(const char *argv0)
{
  printf("Usage: %s [OPTIONS]\n\n"
	 "Supported options:\n"
	 "  -i <iface>   Use network interface <iface>\n"
	 "  -h           Display this text\n",
	 argv0);
  return;
}

int main(int argc, char *argv[])
{
  char buf[1024];
  mmrp_t *msg;
  char *iface = NULL;
  unsigned int i;
  int s;
  ssize_t len;
  
  while((s = getopt(argc, argv, "i:h")) >= 0) {
    switch(s) {
    case 'i':
      iface = optarg;
      break;
    default:
    case 'h':
      usage(argv[0]);
      return(1);
      break;
    }
  }
  
  s = net_socket(PROTO_MMRP, iface);

  if(s < 0) {
    perror("net_socket");
    return(1);
  }

  msg = mmrp_new();
  
  for(i = 0; i < 0xfffffff; i++) {
    len = mmrp_raw(msg, buf, sizeof(buf));

    if(len < 0) {
      perror("mmrp_raw");
    }

    if(mmrp_send(s, buf, len) < 0) {
      perror("net_write");
      break;
    }
  }  

  printf("%u messages sent.\n", i);
  
  net_close(s);
  return(0);
}
