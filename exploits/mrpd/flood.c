#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include "common.h"

static void usage(const char *argv0)
{
  printf("Usage: %s [OPTIONS]\n\n"
	 "Supported options:\n"
	 "  -i <iface>   Use network interface <iface>\n"
	 "  -h           Display this text\n",
	 argv0);
  return;
}

int main(int argc, char *argv[])
{
  char buf[1024];
  mmrp_t *msg;
  char *iface = NULL;
  unsigned int i, j, k, l;
  int s;
  ssize_t len;
  unsigned long long int total_msgs;
  
  while((s = getopt(argc, argv, "i:h")) >= 0) {
    switch(s) {
    case 'i':
      iface = optarg;
      break;
    default:
    case 'h':
      usage(argv[0]);
      return(1);
      break;
    }
  }
  
  s = net_socket(PROTO_MMRP, iface);

  if(s < 0) {
    perror("net_socket");
    return(1);
  }

  total_msgs = 0;

  for(i = 0; i <= 0xff; i++) {
    printf("ver = 0x%02x\n", i);
    for(j = 0; j <= 0xff; j++) {
      printf("\tmsg_type = 0x%02x\n", j);
      for(k = 0; k <= 0xff; k++) {
	printf("\tattr_len = 0x%02x\n", k);
	for(l = 0; l <= 0xffff; l++) {
	  msg = mmrp_new(i);

	  mmrp_msg_append(msg, j, k, l);
	  
	  len = mmrp_raw(msg, buf, sizeof(buf));

	  if(len < 0) {
	    perror("mmrp_raw");
	  }

	  if(mmrp_send(s, buf, len) < 0) {
	    perror("net_write");
	    break;
	  }

	  mmrp_free(msg);
	  total_msgs++;
	}  
      }
    }
  }
  printf("%llu messages sent.\n", total_msgs);
  
  net_close(s);
  return(0);
}
